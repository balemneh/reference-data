<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Skip schema creation for H2 tests -->
    <!-- <changeSet id="001-create-schema" author="reference-data">
        <sql>CREATE SCHEMA IF NOT EXISTS reference_data</sql>
        <sql>CREATE SCHEMA IF NOT EXISTS keycloak</sql>
    </changeSet> -->

    <changeSet id="002-create-code-system-table" author="reference-data">
        <createTable tableName="code_system">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="owner" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="003-create-countries-bitemporal-table" author="reference-data">
        <createTable tableName="countries_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="country_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="country_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iso2_code" type="VARCHAR(2)"/>
            <column name="iso3_code" type="VARCHAR(3)"/>
            <column name="numeric_code" type="VARCHAR(3)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="countries_v" 
                                 baseColumnNames="code_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_countries_code_system"/>
        
        <createIndex tableName="countries_v" indexName="idx_countries_v_lookup">
            <column name="country_code"/>
            <column name="code_system_id"/>
            <column name="valid_from"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-countries-current-view" author="reference-data">
        <!-- H2 doesn't support DISTINCT ON, using a different approach -->
        <createView viewName="countries_current">
            SELECT 
                c.id,
                c.version,
                c.code_system_id,
                c.country_code,
                c.country_name,
                c.iso2_code,
                c.iso3_code,
                c.numeric_code,
                c.valid_from,
                c.valid_to,
                c.recorded_at,
                c.recorded_by,
                c.change_request_id,
                c.metadata
            FROM reference_data.countries_v c
            INNER JOIN (
                SELECT country_code, code_system_id, MAX(version) as max_version
                FROM reference_data.countries_v
                WHERE valid_to IS NULL OR valid_to > CURRENT_DATE
                GROUP BY country_code, code_system_id
            ) latest ON c.country_code = latest.country_code 
                    AND c.code_system_id = latest.code_system_id 
                    AND c.version = latest.max_version
            WHERE c.valid_to IS NULL OR c.valid_to > CURRENT_DATE
        </createView>
    </changeSet>

    <changeSet id="005-create-outbox-table" author="reference-data">
        <createTable tableName="outbox_events">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="aggregate_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="aggregate_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="TIMESTAMP"/>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex tableName="outbox_events" indexName="idx_outbox_events_status">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="006-create-ports-bitemporal-table" author="reference-data">
        <createTable tableName="ports_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="port_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="port_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state_province" type="VARCHAR(100)"/>
            <column name="country_code" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DECIMAL(10,7)"/>
            <column name="longitude" type="DECIMAL(10,7)"/>
            <column name="port_type" type="VARCHAR(50)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="un_locode" type="VARCHAR(10)"/>
            <column name="cbp_port_code" type="VARCHAR(10)"/>
            <column name="timezone" type="VARCHAR(50)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="ports_v" 
                                 baseColumnNames="code_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_ports_code_system"/>
    </changeSet>

    <changeSet id="007-create-airports-bitemporal-table" author="reference-data">
        <createTable tableName="airports_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="iata_code" type="VARCHAR(3)"/>
            <column name="icao_code" type="VARCHAR(4)"/>
            <column name="airport_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state_province" type="VARCHAR(100)"/>
            <column name="country_code" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DECIMAL(10,7)"/>
            <column name="longitude" type="DECIMAL(10,7)"/>
            <column name="elevation_ft" type="INTEGER"/>
            <column name="airport_type" type="VARCHAR(50)"/>
            <column name="is_international" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="timezone" type="VARCHAR(50)"/>
            <column name="cbp_airport_code" type="VARCHAR(10)"/>
            <column name="has_customs" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="has_immigration" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="008-create-carriers-bitemporal-table" author="reference-data">
        <createTable tableName="carriers_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="carrier_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="carrier_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iata_code" type="VARCHAR(2)"/>
            <column name="icao_code" type="VARCHAR(3)"/>
            <column name="country_code" type="VARCHAR(3)"/>
            <column name="carrier_type" type="VARCHAR(50)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="operating_name" type="VARCHAR(100)"/>
            <column name="scac_code" type="VARCHAR(20)"/>
            <column name="dot_number" type="VARCHAR(20)"/>
            <column name="mc_number" type="VARCHAR(20)"/>
            <column name="is_passenger_carrier" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_cargo_carrier" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="alliance" type="VARCHAR(50)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="carriers_v" 
                                 baseColumnNames="code_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_carriers_code_system"/>
    </changeSet>

    <changeSet id="009-create-code-mapping-table" author="reference-data">
        <createTable tableName="code_mapping">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="from_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="from_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="to_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="to_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rule_id" type="VARCHAR(100)"/>
            <column name="confidence" type="DECIMAL(5,2)" defaultValueNumeric="100.00"/>
            <column name="mapping_type" type="VARCHAR(50)"/>
            <column name="is_deprecated" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="deprecation_reason" type="TEXT"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="code_mapping" 
                                 baseColumnNames="from_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_mapping_from_system"/>
                                 
        <addForeignKeyConstraint baseTableName="code_mapping" 
                                 baseColumnNames="to_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_mapping_to_system"/>
    </changeSet>

    <changeSet id="010-insert-initial-code-systems" author="reference-data">
        <insert tableName="code_system">
            <column name="id" valueComputed="RANDOM_UUID()"/>
            <column name="code" value="ISO3166-1"/>
            <column name="name" value="ISO 3166-1 Country Codes"/>
            <column name="description" value="International standard for country codes"/>
            <column name="owner" value="ISO"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
        
        <insert tableName="code_system">
            <column name="id" valueComputed="RANDOM_UUID()"/>
            <column name="code" value="CBP-COUNTRY5"/>
            <column name="name" value="CBP 5-Character Country Codes"/>
            <column name="description" value="CBP internal country code system"/>
            <column name="owner" value="CBP"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
    </changeSet>

</databaseChangeLog>
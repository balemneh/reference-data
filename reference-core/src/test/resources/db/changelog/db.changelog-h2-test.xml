<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Simplified changelog for H2 testing without schemas -->

    <changeSet id="001-create-code-system-table" author="test">
        <createTable tableName="code_system">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="owner" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="002-create-countries-table" author="test">
        <createTable tableName="countries_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="country_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="country_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iso2_code" type="VARCHAR(2)"/>
            <column name="iso3_code" type="VARCHAR(3)"/>
            <column name="numeric_code" type="VARCHAR(3)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="countries_v" 
                                 baseColumnNames="code_system_id"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 constraintName="fk_countries_code_system"/>
        
        <createIndex tableName="countries_v" indexName="idx_countries_v_lookup">
            <column name="country_code"/>
            <column name="code_system_id"/>
            <column name="valid_from"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-change-requests-table" author="test">
        <createTable tableName="change_requests">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cr_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="operation_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="proposed_changes" type="TEXT"/>
            <column name="current_values" type="TEXT"/>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="requester_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="assignee_id" type="VARCHAR(100)"/>
            <column name="approved_by" type="VARCHAR(100)"/>
            <column name="business_justification" type="TEXT"/>
            <column name="rejection_reason" type="VARCHAR(500)"/>
            <column name="priority" type="VARCHAR(10)" defaultValue="MEDIUM"/>
            <column name="submitted_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="approved_at" type="TIMESTAMP"/>
            <column name="implemented_at" type="TIMESTAMP"/>
            <column name="implemented_by" type="VARCHAR(100)"/>
            <column name="rejected_at" type="TIMESTAMP"/>
            <column name="rejected_by" type="VARCHAR(100)"/>
            <column name="approval_data" type="TEXT"/>
            <column name="workflow_instance_id" type="VARCHAR(100)"/>
            <column name="metadata" type="TEXT"/>
        </createTable>

        <createIndex tableName="change_requests" indexName="idx_change_request_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="change_requests" indexName="idx_change_request_requestor">
            <column name="requester_id"/>
        </createIndex>
        <createIndex tableName="change_requests" indexName="idx_change_request_type">
            <column name="operation_type"/>
            <column name="data_type"/>
        </createIndex>
        <createIndex tableName="change_requests" indexName="idx_change_request_created">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-airports-table" author="test">
        <createTable tableName="airports_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="airport_code" type="VARCHAR(10)"/>
            <column name="airport_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iata_code" type="VARCHAR(3)"/>
            <column name="icao_code" type="VARCHAR(4)"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state_province" type="VARCHAR(100)"/>
            <column name="country_code" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DECIMAL(10,7)"/>
            <column name="longitude" type="DECIMAL(10,7)"/>
            <column name="elevation" type="INTEGER"/>
            <column name="airport_type" type="VARCHAR(50)"/>
            <column name="timezone" type="VARCHAR(50)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="airports_v"
                                 baseColumnNames="code_system_id"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 constraintName="fk_airports_code_system"/>
    </changeSet>

    <changeSet id="005-create-ports-table" author="test">
        <createTable tableName="ports_v">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="port_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="port_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="port_type" type="VARCHAR(50)"/>
            <column name="city" type="VARCHAR(255)"/>
            <column name="state_code" type="VARCHAR(10)"/>
            <column name="country_code" type="VARCHAR(10)"/>
            <column name="latitude" type="DECIMAL(10,7)"/>
            <column name="longitude" type="DECIMAL(10,7)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="ports_v"
                                 baseColumnNames="code_system_id"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 constraintName="fk_ports_code_system"/>
    </changeSet>

    <changeSet id="006-create-system-configuration-table" author="test">
        <createTable tableName="system_configuration">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="value" type="TEXT"/>
            <column name="description" type="TEXT"/>
            <column name="configuration_type" type="VARCHAR(50)" defaultValue="APPLICATION">
                <constraints nullable="false"/>
            </column>
            <column name="is_encrypted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(100)"/>
        </createTable>
    </changeSet>

    <changeSet id="007-create-bulk-import-staging-table" author="test">
        <createTable tableName="bulk_import_staging">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="import_batch_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="operation_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="source_system" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="row_number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="natural_key" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="raw_data" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="normalized_data" type="TEXT"/>
            <column name="target_table" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="validation_status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="processing_status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="target_record_id" type="UUID"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="008-create-bulk-import-batches-table" author="test">
        <createTable tableName="bulk_import_batches">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="batch_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="source_system" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="total_records" type="INTEGER" defaultValueNumeric="0"/>
            <column name="records_processed" type="INTEGER" defaultValueNumeric="0"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="009-create-audit-log-table" author="test">
        <createTable tableName="audit_log">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="action" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="UUID"/>
            <column name="operation_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="event_timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID"/>
            <column name="old_values" type="TEXT"/>
            <column name="new_values" type="TEXT"/>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="010-add-foreign-key-constraints" author="test">
        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint baseTableName="countries_v"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_countries_change_request"/>

        <addForeignKeyConstraint baseTableName="airports_v"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_airports_change_request"/>

        <addForeignKeyConstraint baseTableName="ports_v"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_ports_change_request"/>

        <addForeignKeyConstraint baseTableName="bulk_import_staging"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_staging_change_request"/>

        <addForeignKeyConstraint baseTableName="bulk_import_staging"
                                 baseColumnNames="import_batch_id"
                                 referencedTableName="bulk_import_batches"
                                 referencedColumnNames="id"
                                 constraintName="fk_staging_batch"/>

        <addForeignKeyConstraint baseTableName="bulk_import_batches"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_batch_change_request"/>

        <addForeignKeyConstraint baseTableName="audit_log"
                                 baseColumnNames="change_request_id"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 constraintName="fk_audit_change_request"/>
    </changeSet>

    <changeSet id="011-insert-test-data" author="test">
        <insert tableName="code_system">
            <column name="id" value="00000000-0000-0000-0000-000000000001"/>
            <column name="code" value="ISO3166-1"/>
            <column name="name" value="ISO 3166-1 Country Codes"/>
            <column name="description" value="International standard for country codes"/>
            <column name="owner" value="ISO"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
    </changeSet>

</databaseChangeLog>
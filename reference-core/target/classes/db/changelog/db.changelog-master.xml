<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="001-create-schema" author="reference-data">
        <sql>CREATE SCHEMA IF NOT EXISTS reference_data;</sql>
        <sql>CREATE SCHEMA IF NOT EXISTS keycloak;</sql>
    </changeSet>

    <changeSet id="002-create-code-system-table" author="reference-data">
        <createTable tableName="code_system" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="owner" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="003-create-countries-bitemporal-table" author="reference-data">
        <createTable tableName="countries_v" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="country_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="country_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iso2_code" type="VARCHAR(2)"/>
            <column name="iso3_code" type="VARCHAR(3)"/>
            <column name="numeric_code" type="VARCHAR(3)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="JSONB"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="countries_v" 
                                 baseColumnNames="code_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_countries_code_system"/>
        
        <createIndex tableName="countries_v" schemaName="reference_data" indexName="idx_countries_v_lookup">
            <column name="country_code"/>
            <column name="code_system_id"/>
            <column name="valid_from"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-countries-current-view" author="reference-data">
        <createView viewName="countries_current" schemaName="reference_data">
            SELECT DISTINCT ON (country_code, code_system_id)
                id,
                version,
                code_system_id,
                country_code,
                country_name,
                iso2_code,
                iso3_code,
                numeric_code,
                valid_from,
                valid_to,
                recorded_at,
                recorded_by,
                change_request_id,
                metadata
            FROM reference_data.countries_v
            WHERE valid_to IS NULL OR valid_to > CURRENT_DATE
            ORDER BY country_code, code_system_id, version DESC
        </createView>
    </changeSet>

    <changeSet id="005-create-outbox-table" author="reference-data">
        <createTable tableName="outbox_events" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="aggregate_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="aggregate_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="TIMESTAMP"/>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex tableName="outbox_events" schemaName="reference_data" indexName="idx_outbox_events_status">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- Removed: Ports table creation - no longer needed -->

    <!-- Removed: Airports table creation - no longer needed -->

    <!-- Removed: Carriers table creation - moved to future implementation -->
    <!-- changeSet id="008-create-carriers-bitemporal-table" author="reference-data">
        <createTable tableName="carriers_v" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="carrier_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="carrier_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="iata_code" type="VARCHAR(2)"/>
            <column name="icao_code" type="VARCHAR(3)"/>
            <column name="country_code" type="VARCHAR(3)"/>
            <column name="carrier_type" type="VARCHAR(50)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="operating_name" type="VARCHAR(100)"/>
            <column name="scac_code" type="VARCHAR(20)"/>
            <column name="dot_number" type="VARCHAR(20)"/>
            <column name="mc_number" type="VARCHAR(20)"/>
            <column name="is_passenger_carrier" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_cargo_carrier" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="alliance" type="VARCHAR(50)"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="JSONB"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="carriers_v" 
                                 baseColumnNames="code_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_carriers_code_system"/>
    </changeSet -->

    <changeSet id="009-create-code-mapping-table" author="reference-data">
        <createTable tableName="code_mapping" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="from_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="from_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="to_system_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="to_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rule_id" type="VARCHAR(100)"/>
            <column name="confidence" type="DECIMAL(5,2)" defaultValueNumeric="100.00"/>
            <column name="mapping_type" type="VARCHAR(50)"/>
            <column name="is_deprecated" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="deprecation_reason" type="TEXT"/>
            <column name="valid_from" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="valid_to" type="DATE"/>
            <column name="recorded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="recorded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="change_request_id" type="VARCHAR(100)"/>
            <column name="is_correction" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="metadata" type="JSONB"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="code_mapping" 
                                 baseColumnNames="from_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_mapping_from_system"/>
                                 
        <addForeignKeyConstraint baseTableName="code_mapping" 
                                 baseColumnNames="to_system_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="code_system"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_mapping_to_system"/>
    </changeSet>

    <changeSet id="010-insert-initial-code-systems" author="reference-data">
        <insert tableName="code_system" schemaName="reference_data">
            <column name="id" valueComputed="gen_random_uuid()"/>
            <column name="code" value="ISO3166-1"/>
            <column name="name" value="ISO 3166-1 Country Codes"/>
            <column name="description" value="International standard for country codes"/>
            <column name="owner" value="ISO"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
        
        <insert tableName="code_system" schemaName="reference_data">
            <column name="id" valueComputed="gen_random_uuid()"/>
            <column name="code" value="CBP-COUNTRY5"/>
            <column name="name" value="CBP 5-Character Country Codes"/>
            <column name="description" value="CBP internal country code system"/>
            <column name="owner" value="CBP"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
    </changeSet>

    <changeSet id="011-create-change-requests-table" author="reference-data">
        <createTable tableName="change_requests" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cr_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="requester_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="assignee_id" type="VARCHAR(100)"/>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="operation_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="VARCHAR(10)" defaultValue="MEDIUM"/>
            <column name="business_justification" type="TEXT"/>
            <column name="proposed_changes" type="JSONB"/>
            <column name="approval_data" type="JSONB"/>
            <column name="workflow_instance_id" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="submitted_at" type="TIMESTAMP"/>
            <column name="approved_at" type="TIMESTAMP"/>
            <column name="approved_by" type="VARCHAR(100)"/>
            <column name="rejected_at" type="TIMESTAMP"/>
            <column name="rejected_by" type="VARCHAR(100)"/>
            <column name="rejection_reason" type="TEXT"/>
            <column name="implemented_at" type="TIMESTAMP"/>
            <column name="implemented_by" type="VARCHAR(100)"/>
            <column name="metadata" type="JSONB"/>
        </createTable>
        
        <createIndex tableName="change_requests" schemaName="reference_data" indexName="idx_change_requests_status">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
        
        <createIndex tableName="change_requests" schemaName="reference_data" indexName="idx_change_requests_requester">
            <column name="requester_id"/>
        </createIndex>
        
        <createIndex tableName="change_requests" schemaName="reference_data" indexName="idx_change_requests_data_type">
            <column name="data_type"/>
            <column name="operation_type"/>
        </createIndex>
    </changeSet>

    <changeSet id="012-create-change-request-attachments-table" author="reference-data">
        <createTable tableName="change_request_attachments" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="change_request_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="filename" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="file_size" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="file_path" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="checksum" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="uploaded_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="uploaded_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="change_request_attachments" 
                                 baseColumnNames="change_request_id"
                                 baseTableSchemaName="reference_data"
                                 referencedTableName="change_requests"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="reference_data"
                                 constraintName="fk_attachments_change_request"/>
    </changeSet>

    <changeSet id="013-create-data-validation-rules-table" author="reference-data">
        <createTable tableName="validation_rules" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="rule_name" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rule_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rule_definition" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="severity" type="VARCHAR(20)" defaultValue="ERROR">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="description" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createIndex tableName="validation_rules" schemaName="reference_data" indexName="idx_validation_rules_type">
            <column name="data_type"/>
            <column name="rule_type"/>
        </createIndex>
    </changeSet>

    <changeSet id="014-create-workflow-instances-table" author="reference-data">
        <createTable tableName="workflow_instances" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workflow_definition_key" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="process_instance_id" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="business_key" type="VARCHAR(100)"/>
            <column name="entity_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="current_activity" type="VARCHAR(100)"/>
            <column name="assignee" type="VARCHAR(100)"/>
            <column name="variables" type="JSONB"/>
            <column name="started_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="started_by" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="ended_at" type="TIMESTAMP"/>
            <column name="duration_millis" type="BIGINT"/>
        </createTable>
        
        <createIndex tableName="workflow_instances" schemaName="reference_data" indexName="idx_workflow_instances_entity">
            <column name="entity_type"/>
            <column name="entity_id"/>
        </createIndex>
        
        <createIndex tableName="workflow_instances" schemaName="reference_data" indexName="idx_workflow_instances_status">
            <column name="status"/>
            <column name="started_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="015-create-current-views-for-new-tables" author="reference-data">
        <!-- Removed: Views for ports, airports, and carriers - no longer needed -->
    </changeSet>

    <changeSet id="016-add-data-quality-table" author="reference-data">
        <createTable tableName="data_quality_checks" schemaName="reference_data">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="check_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="check_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="records_checked" type="BIGINT"/>
            <column name="records_passed" type="BIGINT"/>
            <column name="records_failed" type="BIGINT"/>
            <column name="failure_rate" type="DECIMAL(5,2)"/>
            <column name="check_results" type="JSONB"/>
            <column name="executed_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="execution_time_ms" type="BIGINT"/>
            <column name="triggered_by" type="VARCHAR(100)"/>
            <column name="threshold_config" type="JSONB"/>
        </createTable>
        
        <createIndex tableName="data_quality_checks" schemaName="reference_data" indexName="idx_quality_checks_data_type">
            <column name="data_type"/>
            <column name="executed_at"/>
        </createIndex>
        
        <createIndex tableName="data_quality_checks" schemaName="reference_data" indexName="idx_quality_checks_status">
            <column name="status"/>
            <column name="failure_rate"/>
        </createIndex>
    </changeSet>

    <!-- Duplicate changeset removed - already defined as 011-create-change-requests-table above -->

</databaseChangeLog>